name: Build wheels and release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5


      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12' # <-- Ensure the tooling is 3.11 or newer

      - name: Install build dependencies
        run: |
          pip install cibuildwheel

      - name: Build wheel with cibuildwheel
        env:
          # Install Boost inside manylinux container
          CIBW_BEFORE_ALL_LINUX: |
            yum install -y boost-devel
        run: |
          python -m cibuildwheel --output-dir wheelhouse

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux
          path: wheelhouse/*.whl

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Boost headers
        run: |
          choco install boost-msvc-14.3 -y --version=1.87.0
        # Headers go into C:\local\boost_*\

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12' # <-- Ensure the tooling is 3.11 or newer

      - name: Install build dependencies
        run: |
          pip install cibuildwheel

      - name: Build wheel with cibuildwheel
        env:
          # Environment inside the wheel build
          CIBW_ENVIRONMENT_WINDOWS: >
              BOOST_ROOT="C:\\local\\boost_1_87_0"
              BOOST_INCLUDEDIR="C:\\local\\boost_1_87_0"
              CMAKE_GENERATOR="Visual Studio 17 2022"
        run: |
          python -m cibuildwheel --output-dir wheelhouse

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows

          path: wheelhouse/*.whl

  release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          # FIX 2: Omit 'name' to download all artifacts to subdirectories (wheels-linux/, wheels-windows/)
          path: dist 

      - name: Move all wheels to root for release
        # The downloaded artifacts are in subdirectories, move them to the root of 'dist'
        run: |
          mkdir final_dist
          find dist -name "*.whl" -exec mv {} final_dist/ \;
          ls -lh final_dist # Check the resulting directory

      - name: Create GitHub Release
        # NOTE: Using yyx990803/release-tag is outdated and can be complex. 
        # softprops/action-gh-release is the current standard.
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }} # Get tag name without the refs/tags/ prefix
          name: Release ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          files: final_dist/*.whl # Point to the flattened directory

  publish-pypi:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5 # FIX 3: Add checkout to access source code

      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: temp_dist 
      
      - name: Flatten wheel directory
        run: |
          mkdir -p dist
          find temp_dist -name "*.whl" -exec mv {} dist/ \;

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@v1.10.0
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          # The packages-dir defaults to 'dist', but we specify it for clarity
          packages-dir: dist/